/*!
 * 
 *   @aptero/axolotis-player v1.0.0
 *   https://github.com/ApteroSAS/axolotis-player
 *
 *   Copyright (c) Aptero (https://github.com/ApteroSAS/axolotis-player) and project contributors.
 *
 *   This source code is licensed under the MIT license found in the
 *   LICENSE file in the root directory of this source tree.
 *
 */
"use strict";(self.webpackChunkaxolotis_player=self.webpackChunkaxolotis_player||[]).push([[7],{7:function(t,e,n){n.r(e),n.d(e,{Factory:function(){return P},default:function(){return k}});var i=n(212),r=n(987);function o(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function s(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return o(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0;return function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=t[Symbol.iterator]()).next.bind(n)}var a,h,u,c,l,p,d,v,f=function(){function t(){}return t.roundNumber=function(t,e){var n=Math.pow(10,e);return Math.round(t*n)/n},t.sample=function(t){return t[Math.floor(Math.random()*t.length)]},t.distanceToSquared=function(t,e){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},t.isPointInPoly=function(t,e){for(var n=!1,i=-1,r=t.length,o=r-1;++i<r;o=i)(t[i].z<=e.z&&e.z<t[o].z||t[o].z<=e.z&&e.z<t[i].z)&&e.x<(t[o].x-t[i].x)*(e.z-t[i].z)/(t[o].z-t[i].z)+t[i].x&&(n=!n);return n},t.isVectorInPolygon=function(t,e,n){var i=1e5,r=-1e5,o=[];return e.vertexIds.forEach((function(t){i=Math.min(n[t].y,i),r=Math.max(n[t].y,r),o.push(n[t])})),!!(t.y<r+.5&&t.y>i-.5&&this.isPointInPoly(o,t))},t.triarea2=function(t,e,n){return(n.x-t.x)*(e.z-t.z)-(e.x-t.x)*(n.z-t.z)},t.vequal=function(t,e){return this.distanceToSquared(t,e)<1e-5},t.mergeVertices=function(t,e){void 0===e&&(e=1e-4),e=Math.max(e,Number.EPSILON);for(var n={},r=t.getIndex(),o=t.getAttribute("position"),s=r?r.count:o.count,a=0,h=[],u=[],c=Math.log10(1/e),l=Math.pow(10,c),p=0;p<s;p++){var d=r?r.getX(p):p,v="";v+=~~(o.getX(d)*l)+",",v+=~~(o.getY(d)*l)+",",(v+=~~(o.getZ(d)*l)+",")in n?h.push(n[v]):(u.push(o.getX(d)),u.push(o.getY(d)),u.push(o.getZ(d)),n[v]=a,h.push(a),a++)}var f=new i.BufferAttribute(new Float32Array(u),o.itemSize,o.normalized),g=new i.BufferGeometry;return g.setAttribute("position",f),g.setIndex(h),g},t}(),g=function(){function t(t){this.content=[],this.scoreFunction=t}var e=t.prototype;return e.push=function(t){this.content.push(t),this.sinkDown(this.content.length-1)},e.pop=function(){var t=this.content[0],e=this.content.pop();return this.content.length>0&&(this.content[0]=e,this.bubbleUp(0)),t},e.remove=function(t){var e=this.content.indexOf(t),n=this.content.pop();e!==this.content.length-1&&(this.content[e]=n,this.scoreFunction(n)<this.scoreFunction(t)?this.sinkDown(e):this.bubbleUp(e))},e.size=function(){return this.content.length},e.rescoreElement=function(t){this.sinkDown(this.content.indexOf(t))},e.sinkDown=function(t){for(var e=this.content[t];t>0;){var n=(t+1>>1)-1,i=this.content[n];if(!(this.scoreFunction(e)<this.scoreFunction(i)))break;this.content[n]=e,this.content[t]=i,t=n}},e.bubbleUp=function(t){for(var e=this.content.length,n=this.content[t],i=this.scoreFunction(n);;){var r=t+1<<1,o=r-1,s=null,a=void 0;if(o<e&&(a=this.scoreFunction(this.content[o]))<i&&(s=o),r<e&&this.scoreFunction(this.content[r])<(null===s?i:a)&&(s=r),null===s)break;this.content[t]=this.content[s],this.content[s]=n,t=s}},t}(),m=function(){function t(){}return t.init=function(t){for(var e=0;e<t.length;e++){var n=t[e];n.f=0,n.g=0,n.h=0,n.cost=1,n.visited=!1,n.closed=!1,n.parent=null}},t.cleanUp=function(t){for(var e=0;e<t.length;e++){var n=t[e];delete n.f,delete n.g,delete n.h,delete n.cost,delete n.visited,delete n.closed,delete n.parent}},t.heap=function(){return new g((function(t){return t.f}))},t.search=function(t,e,n){this.init(t);var i=this.heap();for(i.push(e);i.size()>0;){var r=i.pop();if(r===n){for(var o=r,s=[];o.parent;)s.push(o),o=o.parent;return this.cleanUp(s),s.reverse()}r.closed=!0;for(var a=this.neighbours(t,r),h=0,u=a.length;h<u;h++){var c=a[h];if(!c.closed){var l=r.g+c.cost,p=c.visited;if(!p||l<c.g){if(c.visited=!0,c.parent=r,!c.centroid||!n.centroid)throw new Error("Unexpected state");c.h=c.h||this.heuristic(c.centroid,n.centroid),c.g=l,c.f=c.g+c.h,p?i.rescoreElement(c):i.push(c)}}}}return[]},t.heuristic=function(t,e){return f.distanceToSquared(t,e)},t.neighbours=function(t,e){for(var n=[],i=0;i<e.neighbours.length;i++)n.push(t[e.neighbours[i]]);return n},t}(),y=function(){function t(){}return t.buildZone=function(t,e){var n=this,r=this._buildNavigationMesh(t,e),o={};r.vertices.forEach((function(t){t.x=f.roundNumber(t.x,2),t.y=f.roundNumber(t.y,2),t.z=f.roundNumber(t.z,2)})),o.vertices=r.vertices;var s=this._buildPolygonGroups(r);return o.groups=new Array(s.length),s.forEach((function(t,e){var r=new Map;t.forEach((function(t,e){r.set(t,e)}));var s=new Array(t.length);t.forEach((function(t,e){var a=[];t.neighbours.forEach((function(t){return a.push(r.get(t))}));var h=[];t.neighbours.forEach((function(e){return h.push(n._getSharedVerticesInOrder(t,e))}));var u=new i.Vector3(0,0,0);u.add(o.vertices[t.vertexIds[0]]),u.add(o.vertices[t.vertexIds[1]]),u.add(o.vertices[t.vertexIds[2]]),u.divideScalar(3),u.x=f.roundNumber(u.x,2),u.y=f.roundNumber(u.y,2),u.z=f.roundNumber(u.z,2),s[e]={id:e,neighbours:a,vertexIds:t.vertexIds,centroid:u,portals:h}})),o.groups[e]=s})),o},t._buildNavigationMesh=function(t,e){return t=f.mergeVertices(t,e),this._buildPolygonsFromGeometry(t)},t._spreadGroupId=function(t){for(var e=new Set([t]);e.size>0;){var n=e;e=new Set,n.forEach((function(n){n.group=t.group,n.neighbours.forEach((function(t){void 0===t.group&&e.add(t)}))}))}},t._buildPolygonGroups=function(t){var e=this,n=[];return t.polygons.forEach((function(t){void 0!==t.group?n[t.group].push(t):(t.group=n.length,e._spreadGroupId(t),n.push([t]))})),n},t._buildPolygonNeighbours=function(t,e){var n=new Set,i=e[t.vertexIds[1]],r=e[t.vertexIds[2]];return e[t.vertexIds[0]].forEach((function(e){e!==t&&(i.includes(e)||r.includes(e))&&n.add(e)})),i.forEach((function(e){e!==t&&r.includes(e)&&n.add(e)})),n},t._buildPolygonsFromGeometry=function(t){for(var e=this,n=[],r=[],o=t.attributes.position,s=t.index,a=[],h=0;h<o.count;h++)r.push((new i.Vector3).fromBufferAttribute(o,h)),a[h]=[];for(var u=0;u<t.index.count;u+=3){var c=s.getX(u),l=s.getX(u+1),p=s.getX(u+2),d={vertexIds:[c,l,p],neighbours:null};n.push(d),a[c].push(d),a[l].push(d),a[p].push(d)}return n.forEach((function(t){t.neighbours=e._buildPolygonNeighbours(t,a)})),{polygons:n,vertices:r}},t._getSharedVerticesInOrder=function(t,e){var n=t.vertexIds,i=n[0],r=n[1],o=n[2],s=e.vertexIds,a=s.includes(i),h=s.includes(r),u=s.includes(o);return a&&h&&u?Array.from(n):a&&h?[i,r]:h&&u?[r,o]:a&&u?[o,i]:(console.warn("Error processing navigation mesh neighbors; neighbors with <2 shared vertices found."),[])},t}(),w=function(){function t(){this.portals=[]}var e=t.prototype;return e.push=function(t,e){void 0===e&&(e=t),this.portals.push({left:t,right:e})},e.stringPull=function(){var t,e,n,i=this.portals,r=[],o=0,s=0,a=0;e=i[0].left,n=i[0].right,r.push(t=i[0].left);for(var h=1;h<i.length;h++){var u=i[h].left,c=i[h].right;if(f.triarea2(t,n,c)<=0){if(!(f.vequal(t,n)||f.triarea2(t,e,c)>0)){r.push(e),e=t=e,n=t,s=o=s,a=o,h=o;continue}n=c,a=h}if(f.triarea2(t,e,u)>=0){if(!(f.vequal(t,e)||f.triarea2(t,n,u)<0)){r.push(n),e=t=n,n=t,s=o=a,a=o,h=o;continue}e=u,s=h}}return 0!==r.length&&f.vequal(r[r.length-1],i[i.length-1].left)||r.push(i[i.length-1].left),this.path=r,r},t}(),b=function(){function t(){this.zones={}}t.createZone=function(t,e){return void 0===e&&(e=1e-4),y.buildZone(t,e)};var e=t.prototype;return e.setZoneData=function(t,e){this.zones[t]=e},e.getRandomNode=function(t,e,n,r){if(!this.zones[t])return new i.Vector3;n=n||null,r=r||0;var o=[];return this.zones[t].groups[e].forEach((function(t){n&&r?f.distanceToSquared(n,t.centroid)<r*r&&o.push(t.centroid):o.push(t.centroid)})),f.sample(o)||new i.Vector3},e.getClosestNode=function(t,e,n,i){void 0===i&&(i=!1);var r=this.zones[e].vertices,o=null,s=1/0;return this.zones[e].groups[n].forEach((function(e){var n=f.distanceToSquared(e.centroid,t);n<s&&(!i||f.isVectorInPolygon(t,e,r))&&(o=e,s=n)})),o},e.findPath=function(t,e,n,r){var o=this.zones[n].groups[r],s=this.zones[n].vertices,a=this.getClosestNode(t,n,r,!0),h=this.getClosestNode(e,n,r,!0);if(!a||!h)return null;var u=m.search(o,a,h),c=function(t,e){for(var n=0;n<t.neighbours.length;n++)if(t.neighbours[n]===e.id)return t.portals[n]},l=new w;l.push(t);for(var p=0;p<u.length;p++){var d=u[p+1];if(d){var v=c(u[p],d);l.push(s[v[0]],s[v[1]])}}l.push(e),l.stringPull();var f=l.path.map((function(t){return new i.Vector3(t.x,t.y,t.z)}));return f.shift(),f},t}();b.prototype.getGroup=(a=new i.Plane,function(t,e,n){if(void 0===n&&(n=!1),!this.zones[t])return null;for(var i=null,r=Math.pow(50,2),o=this.zones[t],h=0;h<o.groups.length;h++)for(var u,c=s(o.groups[h]);!(u=c()).done;){var l=u.value;if(n&&(a.setFromCoplanarPoints(o.vertices[l.vertexIds[0]],o.vertices[l.vertexIds[1]],o.vertices[l.vertexIds[2]]),Math.abs(a.distanceToPoint(e))<.01&&f.isPointInPoly([o.vertices[l.vertexIds[0]],o.vertices[l.vertexIds[1]],o.vertices[l.vertexIds[2]]],e)))return h;var p=f.distanceToSquared(l.centroid,e);p<r&&(i=h,r=p)}return i}),b.prototype.clampStep=(c=new i.Vector3,l=new i.Plane,p=new i.Triangle,d=new i.Vector3,v=new i.Vector3,function(t,e,n,i,r,o){var s=this.zones[i].vertices,a=this.zones[i].groups[r],f=[n],g={};g[n.id]=0,h=void 0,v.set(0,0,0),u=1/0,l.setFromCoplanarPoints(s[n.vertexIds[0]],s[n.vertexIds[1]],s[n.vertexIds[2]]),l.projectPoint(e,c),d.copy(c);for(var m=f.pop();m;m=f.pop()){p.set(s[m.vertexIds[0]],s[m.vertexIds[1]],s[m.vertexIds[2]]),p.closestPointToPoint(d,c),c.distanceToSquared(d)<u&&(h=m,v.copy(c),u=c.distanceToSquared(d));var y=g[m.id];if(!(y>2))for(var w=0;w<m.neighbours.length;w++){var b=a[m.neighbours[w]];b.id in g||(f.push(b),g[b.id]=y+1)}}return o.copy(v),h});var M={PLAYER:new i.Color(15631215).convertGammaToLinear(2.2).getHex(),TARGET:new i.Color(14469912).convertGammaToLinear(2.2).getHex(),PATH:new i.Color(41903).convertGammaToLinear(2.2).getHex(),WAYPOINT:new i.Color(41903).convertGammaToLinear(2.2).getHex(),CLAMPED_STEP:new i.Color(14472114).convertGammaToLinear(2.2).getHex(),CLOSEST_NODE:new i.Color(4417387).convertGammaToLinear(2.2).getHex()};!function(t){var e,n;function r(){var e;return(e=t.call(this)||this)._playerMarker=new i.Mesh(new i.SphereBufferGeometry(.25,32,32),new i.MeshBasicMaterial({color:M.PLAYER})),e._targetMarker=new i.Mesh(new i.BoxBufferGeometry(.3,.3,.3),new i.MeshBasicMaterial({color:M.TARGET})),e._nodeMarker=new i.Mesh(new i.BoxBufferGeometry(.1,.8,.1),new i.MeshBasicMaterial({color:M.CLOSEST_NODE})),e._stepMarker=new i.Mesh(new i.BoxBufferGeometry(.1,1,.1),new i.MeshBasicMaterial({color:M.CLAMPED_STEP})),e._pathMarker=new i.Object3D,e._pathLineMaterial=new i.LineBasicMaterial({color:M.PATH,linewidth:2}),e._pathPointMaterial=new i.MeshBasicMaterial({color:M.WAYPOINT}),e._pathPointGeometry=new i.SphereBufferGeometry(.08),e._markers=[e._playerMarker,e._targetMarker,e._nodeMarker,e._stepMarker,e._pathMarker],e._markers.forEach((function(t){t.visible=!1,e.add(t)})),e}n=t,(e=r).prototype=Object.create(n.prototype),e.prototype.constructor=e,e.__proto__=n;var o=r.prototype;o.setPath=function(t){for(;this._pathMarker.children.length;)this._pathMarker.children[0].visible=!1,this._pathMarker.remove(this._pathMarker.children[0]);t=[this._playerMarker.position].concat(t);var e=new i.BufferGeometry;e.setAttribute("position",new i.BufferAttribute(new Float32Array(3*t.length),3));for(var n=0;n<t.length;n++)e.attributes.position.setXYZ(n,t[n].x,t[n].y+.2,t[n].z);this._pathMarker.add(new i.Line(e,this._pathLineMaterial));for(var r=0;r<t.length-1;r++){var o=new i.Mesh(this._pathPointGeometry,this._pathPointMaterial);o.position.copy(t[r]),o.position.y+=.2,this._pathMarker.add(o)}return this._pathMarker.visible=!0,this},o.setPlayerPosition=function(t){return this._playerMarker.position.copy(t),this._playerMarker.visible=!0,this},o.setTargetPosition=function(t){return this._targetMarker.position.copy(t),this._targetMarker.visible=!0,this},o.setNodePosition=function(t){return this._nodeMarker.position.copy(t),this._nodeMarker.visible=!0,this},o.setStepPosition=function(t){return this._stepMarker.position.copy(t),this._stepMarker.visible=!0,this},o.reset=function(){for(;this._pathMarker.children.length;)this._pathMarker.children[0].visible=!1,this._pathMarker.remove(this._pathMarker.children[0]);return this._markers.forEach((function(t){t.visible=!1})),this}}(i.Object3D);function x(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}class z{constructor(){x(this,"zone","character"),x(this,"navGroup",null),x(this,"navNode",null)}isEnabled(){return this.pathfinder&&this.zone in this.pathfinder.zones}loadMesh(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.zone;this.pathfinder=new b,this.mesh=null,this.zone=e,this.mesh&&(console.error("tried to load multiple nav meshes"),this.removeNavMeshData());const n=t.geometry;n.applyMatrix4(t.matrixWorld),this.pathfinder.setZoneData(e,b.createZone(n)),this.mesh=t}getClosestNode(t){const e=this.pathfinder;return e.zones[this.zone].groups[this.navGroup]?e.getClosestNode(t,this.zone,this.navGroup,!0)||e.getClosestNode(t,this.zone,this.navGroup):null}findPositionOnNavMesh(t,e,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=this.pathfinder;if(this.zone in r.zones){if(this.navGroup=i||null===this.navGroup?r.getGroup(this.zone,e,!0,!0):this.navGroup,this.navNode=i||null===this.navNode||void 0===this.navNode?this.getClosestNode(e):this.navNode,null===this.navNode||void 0===this.navNode)n.copy(e);else try{this.navNode=r.clampStep(t,e,this.navNode,this.zone,this.navGroup,n)}catch(e){n.copy(t),this.navNode=null,this.navGroup=null}return n}}removeNavMeshData(){this.mesh&&this.mesh.geometry&&this.mesh.geometry.dispose&&this.mesh.geometry.dispose(),this.mesh=null,this.pathfinder.zones={}}}function _(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}class P{async create(t,e){let n=t.getFirstComponentByType(r.e.name),o=await n.getService("@root/lib/modules/three/ThreeLib"),s=await n.getService("@root/lib/modules/controller/pathFindingPlayer/Input"),a=await n.getService("@root/lib/modules/controller/PlayerService"),h=await n.getService("@root/lib/modules/FrameLoop"),u=new i.Vector3(e.position&&e.position.x||0,e.position&&e.position.y||0,e.position&&e.position.z||0),c=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,1,0),.5*-Math.PI),l=new k(u,c,await o,await s,a);return a.declarePlayer(l),l.Initialize(),(await h).addLoop(k.name,(t=>{l.Update(t)})),l}}class k{getType(){return k.name}askFlyMode(){}declareNavMesh(t){this.navMesh.loadMesh(t,"character")}teleportToLocation(t,e,n){this.position.copy(new i.Vector3(t,e,n))}getHeadPosition(t){t.copy(this.position)}constructor(t,e,n,r,o){_(this,"positionOutTmp",new i.Vector3),_(this,"positionOutTmp2",new i.Vector3),_(this,"OnPointerlockChange",(()=>{document.pointerLockElement?this.isLocked=!0:this.isLocked=!1})),_(this,"OnMouseMove",(t=>{if(!this.isLocked)return;const{movementX:e,movementY:n}=t;this.angles.y-=e*this.mouseSpeed,this.angles.x-=n*this.mouseSpeed,this.angles.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.angles.x)),this.UpdateRotation()})),_(this,"Accelarate",((t,e)=>{const n=this.tempVec.copy(t).multiplyScalar(this.acceleration*e);this.speed.add(n),this.speed.clampLength(0,this.maxSpeed)})),_(this,"Deccelerate",(t=>{const e=this.tempVec.copy(this.speed).multiplyScalar(this.decceleration*t);this.speed.add(e)})),this.input=r,this.playerService=o,this.position=t,this.rotation=e,this.navMesh=new z,this.camera=n.camera,this.timeZeroToMax=.08,this.maxSpeed=7,this.speed=new i.Vector3,this.acceleration=this.maxSpeed/this.timeZeroToMax,this.decceleration=-7,this.mouseSpeed=.002,this.isLocked=!1,this.angles=new i.Euler,this.pitch=new i.Quaternion,this.yaw=new i.Quaternion,this.jumpVelocity=5,this.yOffset=2,this.tempVec=new i.Vector3,this.moveDir=new i.Vector3,this.xAxis=new i.Vector3(1,0,0),this.yAxis=new i.Vector3(0,1,0),this.velocity=new i.Vector3}Initialize(){this.angles.setFromQuaternion(this.rotation),this.UpdateRotation(),this.input.AddMouseMoveListner(this.OnMouseMove),document.addEventListener("pointerlockchange",this.OnPointerlockChange),this.input.AddClickListner((()=>{this.isLocked||document.body.requestPointerLock()}))}UpdateRotation(){this.pitch.setFromAxisAngle(this.xAxis,this.angles.x),this.yaw.setFromAxisAngle(this.yAxis,this.angles.y),this.rotation.multiplyQuaternions(this.yaw,this.pitch).normalize(),this.camera.quaternion.copy(this.rotation)}Update(t){t*=.001;const e=this.input.GetKeyDown("KeyS")-this.input.GetKeyDown("KeyW"),n=this.input.GetKeyDown("KeyD")-this.input.GetKeyDown("KeyA"),i=this.moveDir.set(n,0,e).normalize();this.Deccelerate(t),this.Accelarate(i,t);const r=this.tempVec.copy(this.speed);r.applyQuaternion(this.yaw),this.velocity.setX(r.x),this.velocity.setZ(r.z),this.velocity.multiplyScalar(t),this.positionOutTmp.x=this.position.x+this.velocity.x,this.positionOutTmp.y=this.position.y+this.velocity.y,this.positionOutTmp.z=this.position.z+this.velocity.z,this.navMesh.isEnabled()?(this.navMesh.findPositionOnNavMesh(this.position,this.positionOutTmp,this.positionOutTmp2),this.positionOutTmp2.y=this.positionOutTmp2.y+this.yOffset):this.positionOutTmp2.copy(this.positionOutTmp),this.camera.position.set(this.positionOutTmp2.x,this.positionOutTmp2.y,this.positionOutTmp2.z),this.position.copy(this.camera.position)}}}}]);
//# sourceMappingURL=7.index.js.map