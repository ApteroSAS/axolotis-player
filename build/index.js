/*!
 * 
 *   @aptero/axolotis-player v1.0.0
 *   https://github.com/ApteroSAS/axolotis-player
 *
 *   Copyright (c) Aptero (https://github.com/ApteroSAS/axolotis-player) and project contributors.
 *
 *   This source code is licensed under the MIT license found in the
 *   LICENSE file in the root directory of this source tree.
 *
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("axolotis-player",[],e):"object"==typeof exports?exports["axolotis-player"]=e():t["axolotis-player"]=e()}(self,(function(){return function(){"use strict";var t={630:function(t,e,o){function n(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}o.r(e),o.d(e,{Factory:function(){return r},FrameLoop:function(){return i}});class r{async createService(t){let e=await t.getService("@root/lib/modules/core/loader/CodeLoaderService"),o=new i;return e.awaitInitialLoading().then((()=>{o.startAnimationFrameLoop()})),o}}class i{constructor(){n(this,"loops",{}),n(this,"prevTime",0),n(this,"monitoringStart",(()=>{})),n(this,"monitoringEnd",(()=>{}))}startAnimationFrameLoop(){const t=e=>{this.monitoringStart(i.name);const o=e-this.prevTime;this.prevTime=e,requestAnimationFrame(t);for(const t in this.loops)this.monitoringStart(t),this.loops[t](o),this.monitoringEnd(t);this.monitoringEnd(i.name)};requestAnimationFrame(t)}setMonitoringCallback(t,e){this.monitoringStart=t,this.monitoringEnd=e}removeLoop(t){delete this.loops[t],this.monitoringStart(t),this.monitoringEnd(t)}addLoop(t,e){if(this.loops[t])throw new Error;this.loops[t]=e}getType(){return i.name}}},905:function(t,e,o){o.r(e),o.d(e,{Factory:function(){return r},WorldService:function(){return u},registerNewWorld:function(){return l}});var n=o(454);class r{constructor(){}async createService(t){return new u(t)}}let i=-1,s=[],a=[],c=[];function l(t){s.push(t),i<0&&(i=0,window.axolotis.world=s[i],window.axolotis.activeWorld=i)}window&&(window.axolotis||(window.axolotis={}),window.axolotis.worlds=s,window.axolotis.activeWorld=i);class u{constructor(t){var e,o,r;r=void 0,(o="world")in(e=this)?Object.defineProperty(e,o,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[o]=r,console.log("info");let s=null;for(const e of this.getWorlds()){e.getFirstComponentByType(n.e.name)==t&&(s=e)}if(!s)throw new Error;this.world=s,t.getService("@root/lib/modules/core/loader/CodeLoaderService").then((async t=>{t.awaitInitialLoading();for(const t of c)t()})),i>=0&&this.setActiveWorldByNumber(i)}getType(){return u.name}getWorlds(){return s}getActiveWorld(){return s[i]}isActiveWorld(){return this.world==this.getActiveWorld()}addOnWorldChangeCallback(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];a.push(t),e&&t()}addOnWorldAdded(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];c.push(t),e&&t()}setActiveWorld(t){for(let e=0;e<this.getWorlds().length;e++)if(t==this.getWorlds()[e])return void this.setActiveWorldByNumber(e);throw new Error}setActiveWorldByNumber(t){if(i!=t){i=t,window&&window.axolotis&&(window.axolotis.activeWorld=i,window.axolotis.world=s[i]);for(const t of a)t()}}}},915:function(t,e,o){o.d(e,{V:function(){return s},A:function(){return i}});var n=o(415);let r={};function i(t,e){r[t]=e}async function s(t,e){let o=null;return o=r[t]?await async function(t,e){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const n=await o[t]();for(const t in n){const o=n[t];if(o.prototype&&o.prototype.constructor.name===e)return new o}throw new Error("invalid factory "+t+" - "+e)}(t,e,r):await(0,n.o)(t,e),o}},415:function(t,e,o){async function n(t,e){if("@root/lib/modules/core/WorldService"===t&&"Factory"===e){return(await Promise.resolve().then(o.bind(o,905))).Factory.name}if("@root/lib/modules/FrameLoop"===t&&"Factory"===e){return(await Promise.resolve().then(o.bind(o,630))).Factory.name}throw new Error("Class Not Found")}async function r(t,e){const r=await async function(t){switch(t){case"@root/lib/modules/core/WorldService":return Promise.resolve().then(o.bind(o,905));case"@root/lib/modules/FrameLoop":return Promise.resolve().then(o.bind(o,630));default:throw new Error(t+" not found in module list - please run npm run pre-build")}}(t);for(const o in r){const i=r[o];if(i.prototype&&i.prototype.constructor.name===await n(t,e))return new i}throw new Error("invalid factory "+t+" - "+e)}o.d(e,{o:function(){return r}})},240:function(t,e,o){o.d(e,{i:function(){return r}});var n=o(915);class r{constructor(){var t,e,o;o={},(e="service")in(t=this)?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o}toId(t,e){return t+":"+e}setService(t,e){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"Factory";this.service[this.toId(t,o)]=Promise.resolve(e)}async getService(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Factory";if(this.service[this.toId(t,e)]){const o=await this.service[this.toId(t,e)];if(!o)throw new Error("error");return o}if(!this.service[this.toId(t,e)]){let o=(0,n.V)(t,e);this.service[this.toId(t,e)]=new Promise((async t=>{t(await(await o).createService(this))}))}return await this.service[this.toId(t,e)]}}},454:function(t,e,o){o.d(e,{e:function(){return r}});var n=o(240);class r extends n.i{getType(){return r.name}}},147:function(t){t.exports={i8:"1.0.0"}}},e={};function o(n){var r=e[n];if(void 0!==r)return r.exports;var i=e[n]={exports:{}};return t[n](i,i.exports,o),i.exports}o.d=function(t,e){for(var n in e)o.o(e,n)&&!o.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};return function(){o.r(n),o.d(n,{CodeLoaderComponent:function(){return a},Component:function(){return t.default},ComponentFactory:function(){return e.ComponentFactory},Entity:function(){return l},FrameLoop:function(){return g.FrameLoop},LazyServices:function(){return w.i},ServiceEntity:function(){return r.e},WebpackLazyModule:function(){return y.WebpackLazyModule},WorldEntity:function(){return d},WorldService:function(){return u.WorldService},initHtml:function(){return f},registerLocalModule:function(){return i.A}});var t={};o.r(t);var e={};o.r(e);var r=o(454),i=o(915);function s(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}class a{constructor(){s(this,"initialLoading",void 0),s(this,"initialLoadingResolver",void 0),s(this,"roomUrl",""),this.initialLoading=new Promise((t=>{this.initialLoadingResolver=t}))}cleanUpRoomUrl(t){return t.endsWith(".json")||(t+="/room.json"),t.replace("./",""),t.startsWith("http")||(t=window.location.origin+"/"+t),t}async loadRoomDefinitionFile(t){t=this.cleanUpRoomUrl(t),this.roomUrl=t;let e=await fetch(t);return await e.json()}async searchRoomDefinitionFile(){if(window.axolotis&&window.axolotis.room)return window.axolotis.room;for(const t of window.document.head.children)if("META"===t.tagName&&"axolotis:room"===t.name){let e=t.content;return this.loadRoomDefinitionFile(e)}throw new Error("No room definition found in meta axolotis:room")}getType(){return a.name}async awaitInitialLoading(){await this.initialLoading}async startLoadingJson(t,e,o){let n=[];for(const o of e.entities)for(const e of o.components){let o=e.config;n.push((()=>new Promise((async(n,r)=>{let s=e.classname||"Factory";const a=await(0,i.V)(e.module,s);let c=await a.createComponent(t,o||{});if(!c.getType)throw new Error("Not a component : "+e.module+" "+c.constructor.name);t.addComponent(c),n(a)}))))}for(const o of e.services)n.push((()=>new Promise((async(e,n)=>{let i=await t.getFirstComponentByType(r.e.name);await i.getService(o.module),e(i)}))));let s=function(t,e){let o=[],n=0;for(const r of t){const i=r();o.push(i),i.then((()=>{n++,e(n,t.length)}))}return Promise.all(o)}(n,o);return s.then((t=>{void 0!==this.initialLoadingResolver&&this.initialLoadingResolver(t)})),s.catch((t=>{console.error(t)})),s}}function c(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var l=class{constructor(t){this.name=t,c(this,"components",[]),c(this,"waitingForComponent",{})}addComponent(t){if(this.components.push(t),this.waitingForComponent[t.getType()]){for(const e of this.waitingForComponent[t.getType()])e(t);delete this.waitingForComponent[t.getType()]}return t}removeAllComponents(){this.components.forEach((t=>{this.removeComponent(t)}))}removeComponent(t){return"destroy"in t&&t.destroy(),this.components=this.components.filter((e=>e!=t)),t}addComponents(t){t.forEach((t=>{this.addComponent(t)}))}getComponents(){return this.components}getComponentByType(t){let e=[];return this.components.forEach((o=>{o.getType()===t&&e.push(o)})),e}getComponentByTypeStartsWith(t){let e=[];return this.components.forEach((o=>{o.getType().startsWith(t)&&e.push(o)})),e}getFirstComponentByTypeStartsWith(t){return this.getComponentByTypeStartsWith(t)[0]}getFirstComponentByType(t){return this.getComponentByType(t)[0]}async getFirstComponentByTypeAsync(t){if(this.getComponentByType(t)[0])return this.getComponentByType(t)[0];return this.waitingForComponent[t]||(this.waitingForComponent[t]=[]),new Promise(((e,o)=>{this.waitingForComponent[t].push(e)}))}getType(){return this.name}},u=o(905);class d extends l{constructor(){super("world"),(0,u.registerNewWorld)(this)}}const m=o(147).i8;console.log(m);const p=t=>{"complete"===document.readyState&&document.body?t():window.addEventListener("DOMContentLoaded",t)};function f(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.onProgress||(t.onProgress=()=>{}),t.onLoaded||(t.onLoaded=()=>{});let e=new r.e,o=new d;o.addComponent(e);let n=new a;e.setService("@root/lib/modules/core/loader/CodeLoaderService",n),p((()=>{let e=window.document.body.getElementsByTagName("ax-scene");if(!e||e&&0==e.length)return console.warn("Axolotis scene not found (no tag ax-scene)"),void t.onLoaded();console.log(e),n.startLoadingJson(o,h(e),t.onProgress).then(t.onLoaded)}))}function h(t){let e=t[0];const o={version:"2.0",entities:[],services:[]};for(const t of e.getElementsByTagName("ax-entity")){let e={components:[]};for(const o of t.getElementsByTagName("ax-component")){let t=o.getAttribute("config").replace(/(['"])?([a-z0-9A-Z_]+)(['"])?:/g,'"$2": '),n={module:o.getAttribute("module"),config:JSON.parse(t)};e.components.push(n)}o.entities.push(e)}for(const t of e.getElementsByTagName("ax-service"))o.services.push({module:t.getAttribute("module")});return o}var w=o(240),g=o(630),y=o(415)}(),n}()}));
//# sourceMappingURL=index.js.map